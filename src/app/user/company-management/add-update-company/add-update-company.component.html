<mat-card class="user-card">
  <div class="dialog-header">
    <h2>{{ companyData ? 'Edit Company' : 'Add Company' }}</h2>
    <button class="close_btn" mat-icon-button color="warn" (click)="onCancel()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <form [formGroup]="form" (ngSubmit)="onSubmit()" class="form-grid">
    <!-- Company Selection -->
    <mat-form-field appearance="outline">
      <mat-label>Company Type Selection</mat-label>
      <mat-select formControlName="companySelection">
        <mat-option *ngFor="let option of companySelectionOptions" [value]="option.value">
          {{ option.key }}
        </mat-option>
      </mat-select>
      <mat-error *ngIf="form.get('companySelection')?.hasError('required')">Company Selection is required</mat-error>
    </mat-form-field>

    <!-- Company Type -->
    <!-- <mat-form-field appearance="outline">
      <mat-label>Company Type</mat-label>
      <mat-select formControlName="companyType">
        <mat-option *ngFor="let type of companyType" [value]="type.id">{{ type.name }}</mat-option>
      </mat-select>
      <mat-error *ngIf="form.get('companyType')?.hasError('required')">Company Type is required</mat-error>
    </mat-form-field> -->

    <!-- Country -->
    <mat-form-field appearance="outline">
      <mat-label>Country</mat-label>
      <mat-select formControlName="country">
        <mat-option *ngFor="let country of countries" [value]="country.id">{{ country.name }}</mat-option>
      </mat-select>
      <mat-error *ngIf="form.get('country')?.hasError('required')">Country is required</mat-error>
    </mat-form-field>

    <!-- Supported Currencies -->
    <mat-form-field appearance="outline">
      <mat-label>Supported Currencies</mat-label>
      <mat-select formControlName="supportedCurrencies" multiple>
        <mat-option *ngFor="let currency of currencies" [value]="currency.id">{{ currency.name }}</mat-option>
      </mat-select>
      <mat-error *ngIf="form.get('supportedCurrencies')?.hasError('required')">Supported Currencies are
        required</mat-error>
    </mat-form-field>

        <mat-form-field appearance="outline">
      <mat-label>Provider</mat-label>
      <mat-select formControlName="providers">
        <mat-option *ngFor="let option of providerOption" [value]="option.id">
          {{ option.name }}
        </mat-option>
      </mat-select>
      <mat-error *ngIf="form.get('companySelection')?.hasError('required')">Provider is required</mat-error>
    </mat-form-field>

    <!-- Name -->
    <mat-form-field appearance="outline">
      <mat-label>Name</mat-label>
      <input matInput formControlName="name" maxlength="20" placeholder="Enter Company Name"
        [appPatternRestrict]="pattern.alphaNumericWithSpace" />
      <mat-error *ngIf="form.get('name')?.hasError('required')">Name is required</mat-error>
    </mat-form-field>

    <!-- ID -->
    <mat-form-field appearance="outline">
      <mat-label>ID</mat-label>
      <input matInput formControlName="id" maxlength="20" placeholder="Enter ID"
        [appPatternRestrict]="pattern.mobile" />
      <mat-error *ngIf="form.get('id')?.hasError('required')">ID is required</mat-error>
      <mat-error *ngIf="form.get('id')?.hasError('minlength')">
        ID must be at least {{ form.get('id')?.errors?.['minlength']?.requiredLength }} characters
      </mat-error>
    </mat-form-field>

    <!-- API Paths -->
    <div formArrayName="apiPaths" class="api-paths">
      <div *ngFor="let path of apiPaths.controls; let i = index" [formGroupName]="i" class="api-path-row">
        <mat-form-field style="width: 85% !important;" appearance="outline" class="api-path-input">
          <mat-label>API Path</mat-label>
          <input matInput formControlName="value" maxlength="200" placeholder="Enter API Path"
            [appPatternRestrict]="pattern.password" />
          <mat-error *ngIf="path.get('value')?.invalid && path.get('value')?.touched">API Path is required</mat-error>
        </mat-form-field>

        <button type="button" *ngIf="apiPaths.length > 1" mat-icon-button color="warn" (click)="removeApiPath(i)">
          <mat-icon>delete</mat-icon>
        </button>

        <button type="button" *ngIf="i == apiPaths.length - 1" mat-icon-button color="primary" (click)="addApiPath()">
          <mat-icon>add</mat-icon>
        </button>
      </div>
    </div>

    <!-- Sport Category and SubType Dynamic FormArray -->
    <!-- <div formArrayName="sportTypeAndSubType">
      <div *ngFor="let group of sportTypeAndSubType.controls; let i = index" [formGroupName]="i" class="sport-pair-row">
        <mat-form-field style="width: 42% !important;" appearance="outline">
          <mat-label>Sport Category Type</mat-label>
          <mat-select formControlName="sport_category">
            <mat-option *ngFor="let type of sportTypes" [value]="type">{{ type.name }}</mat-option>
          </mat-select>
          <mat-error *ngIf="group.get('sport_category')?.hasError('required')">Sport Category is required</mat-error>
        </mat-form-field>

        <mat-form-field style="width: 43% !important;" appearance="outline">
          <mat-label>Sub Type</mat-label>
          <mat-select formControlName="sub_types" multiple>
            <mat-option *ngFor="let item of group.get('sub_type_options')?.value" [value]="item._id">
              {{ item.name }}
            </mat-option>
          </mat-select>
          <mat-error *ngIf="group.get('sub_types')?.hasError('required')">Sub Type is required</mat-error>
        </mat-form-field>

        <div class="sport-buttons">
          <button *ngIf="sportTypeAndSubType.length > 1" mat-icon-button color="warn" (click)="removeSportTypeGroup(i)">
            <mat-icon>delete</mat-icon>
          </button>
          <button *ngIf="i == sportTypeAndSubType.length - 1" mat-icon-button color="primary"
            (click)="addSportTypeGroup()">
            <mat-icon>add</mat-icon>
          </button>
        </div>
      </div>
    </div> -->

    <!-- No longer using FormArray here -->
   <div *ngFor="let group of sportTypeAndSubTypeModel; let i = index" class="sport-pair-row">
  <!-- Sport Type -->
  <mat-form-field style="width: 42% !important;" appearance="outline">
    <mat-label>Sport Category Type</mat-label>
    <mat-select [(ngModel)]="group.typeId"   [ngModelOptions]="{ standalone: true }" name="typeId-{{i}}" (selectionChange)="onSportTypeChange(group)">
      <mat-option *ngFor="let type of sportTypes" [value]="type.id">{{ type.name }}</mat-option>
    </mat-select>
  </mat-form-field>

  <!-- Sub Type -->
  <mat-form-field style="width: 43% !important;" appearance="outline">
    <mat-label>Sub Type</mat-label>
    <mat-select [(ngModel)]="group.subTypeId"  [ngModelOptions]="{ standalone: true }" name="subTypeId-{{i}}" multiple>
      <mat-option *ngFor="let sub of getSubTypesFor(group.typeId)" [value]="sub._id">
        {{ sub.name }}
      </mat-option>
    </mat-select>
  </mat-form-field>

  <!-- Add/Remove -->
  <div class="sport-buttons">
    <button type="button" *ngIf="sportTypeAndSubTypeModel.length > 1" mat-icon-button color="warn" (click)="removeSportTypeGroup(i)">
      <mat-icon>delete</mat-icon>
    </button>
    <button type="button" *ngIf="i == sportTypeAndSubTypeModel.length - 1" mat-icon-button color="primary"
      (click)="addSportTypeGroup()">
      <mat-icon>add</mat-icon>
    </button>
  </div>
</div>



    <!-- Submit Button -->
    <div class="button_container">
      <button class="submit_btn submit_clr" mat-raised-button color="primary" type="submit" [disabled]="loading">
        <mat-spinner *ngIf="loading" diameter="20"></mat-spinner>
        {{ loading ? 'Saving...' : (companyData ? 'Update Company' : 'Add Company') }}
      </button>
      <button class="submit_btn cancel_btn" mat-raised-button color="primary" type="button" (click)="onCancel()">
        Cancel
      </button>
      
    </div>
  </form>
</mat-card>